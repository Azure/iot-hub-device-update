name: deviceupdate-agent # you probably want to 'snapcraft register <name>'
base: core20 # the base snap is the execution environment for this snap
version: '0.1' # just for humans, typically '1.2+git' or '1.3.2'
summary: IoT Hub Device Update Agent for Ubuntu Core # 79 char long summary
description: |
   A proof-of-concept for the Device Update Agent Ubuntu Core snap.

grade: devel # must be 'stable' to release into candidate/stable channels
confinement: devmode # use 'strict' once you have the right plugs and slots

#####
#
# Keywords
#
# after  - Specifies part's dependencies.
#              See https://snapcraft.io/docs/parts-lifecycle#heading--step-dependencies
#                  https://snapcraft.io/docs/parts-lifecycle
# plugin - Specifies a plugin required for building the part.
#
#####

parts:
  installdeps:
    plugin: nil
    source: .
    override-build: |
      ./scripts/install-deps.sh -a

  #
  # Agent component
  # This is the main agent application.
  #
  agent:
    plugin: nil
    source: .
    override-build: |
      ./scripts/build.sh --ubuntu-core-snap-only
      mkdir -p ../install/usr/bin
      mkdir -p ../install/usr/lib/adu
      mkdir -p ../install/var/lib/adu/extensions/sources
      cp ../build/out/bin/AducIotAgent ../install/usr/bin/AducIotAgent
      cp /usr/lib/libdeliveryoptimization.so* ../install/usr/lib
      cp ../build/out/bin/adu-shell ../install/usr/lib/adu
      cp ../build/out/lib/*.so ../install/var/lib/adu/extensions/sources

    # Require install-deps
    after:
     - installdeps
    stage:
      - usr/bin/*
      - usr/lib/*
      - usr/lib/adu/*
      - var/lib/adu/extensions/sources/*.so
    # stage-packages:
    #   - libasn1-8-heimdal
    #   - libboost-filesystem1.71.0
    #   - libbrotli1
    #   - libcurl4
    #   - libgssapi3-heimdal
    #   - libhcrypto4-heimdal
    #   - libheimbase1-heimdal
    #   - libheimntlm0-heimdal
    #   - libhx509-5-heimdal
    #   - libicu66
    #   - libkrb5-26-heimdal
    #   - libldap-2.4-2
    #   - libnghttp2-14
    #   - libpsl5
    #   - libroken18-heimdal
    #   - librtmp1
    #   - libsasl2-2
    #   - libssh-4
    #   - libwind0-heimdal
    #   - libxml2
    #   - libdeliveryoptimization

# TODO: define the deviceupdate-agent daemon
apps:
  # Defines 'deviceupdate-agent' service
  # See document: https://forum.snapcraft.io/t/snapcraft-app-and-service-metadata/8335
  deviceupdate-agent:
    command : usr/bin/AducIotAgent
    daemon: simple
    refresh-mode: restart
    restart-condition: always
    restart-delay: 10s

