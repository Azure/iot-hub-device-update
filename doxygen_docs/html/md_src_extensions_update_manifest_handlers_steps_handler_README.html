<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Device Update for IotHub: Steps Handler (or Update Manifest Handler)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Device Update for IotHub
   &#160;<span id="projectnumber">1.0.1</span>
   </div>
   <div id="projectbrief">Device Update for IoTHub delivers client update from the Device Update for IotHub service.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Steps Handler (or Update Manifest Handler) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md123"></a>
Introducing Install Instructions Step</h1>
<p>At the Device Update Public Preview Refresh, the top level Update Manifest version v4 will no longer contain the <code>UpdateType</code> property, instead it will have one or more <code>instruction.steps</code> data.</p>
<h2><a class="anchor" id="autotoc_md124"></a>
Example Update Manifest with Steps</h2>
<p>The following is an example of the Update Manifest version v4 that contains two instruction steps. In this example, both steps are <code>inline</code> step. 'Inline' step is the default value if not specified.</p>
<blockquote class="doxtable">
<p>Note: see <a href="../../../docs/agent-reference/update-manifest-v4-schema.md#multi-step-ordered-execution-msoe-support">Multi Step Ordered Execution</a> for more information about <code>step</code>. The step's <code>handler</code> property is equivalent to an <code>Update Type</code> that was introduced in the previous version of the Update Manifest. </p>
</blockquote>
<blockquote class="doxtable">
<p>Note: the step data also contains a property called <code>handlerProperties</code>. This is a JSON object that contains the data (such as, installedCriteria, script arguments, etc.) usually used by the Handler when performing various update tasks (such as download, install, apply, and cancel) </p>
</blockquote>
<p>Usually, the Handler implementer is responsible for defining the set of properties, what they are, how and when they are used.</p>
<div class="fragment"><div class="line"><span class="stringliteral">&quot;updateId&quot;</span>: {...},</div>
<div class="line"><span class="stringliteral">&quot;compatibility&quot;</span>: [</div>
<div class="line">    {</div>
<div class="line">        <span class="stringliteral">&quot;manufacturer&quot;</span>: <span class="stringliteral">&quot;adu-device&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;model&quot;</span>: <span class="stringliteral">&quot;e2e-test&quot;</span></div>
<div class="line">    }</div>
<div class="line">],</div>
<div class="line"><span class="stringliteral">&quot;instructions&quot;</span>: {</div>
<div class="line">    <span class="stringliteral">&quot;steps&quot;</span>: [</div>
<div class="line">        {</div>
<div class="line">            <span class="stringliteral">&quot;description&quot;</span>: <span class="stringliteral">&quot;Install libcurl4-doc on host device&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;handler&quot;</span>: <span class="stringliteral">&quot;microsoft/apt:1&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;files&quot;</span>: [</div>
<div class="line">                <span class="stringliteral">&quot;apt-manifest-1.0.json&quot;</span></div>
<div class="line">            ],</div>
<div class="line">            <span class="stringliteral">&quot;handlerProperties&quot;</span>: {</div>
<div class="line">                <span class="stringliteral">&quot;installedCriteria&quot;</span>: <span class="stringliteral">&quot;apt-update-test-2.2&quot;</span></div>
<div class="line">            }</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            <span class="stringliteral">&quot;description&quot;</span>: <span class="stringliteral">&quot;Install tree on host device&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;handler&quot;</span>: <span class="stringliteral">&quot;microsoft/apt:1&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;files&quot;</span>: [</div>
<div class="line">                <span class="stringliteral">&quot;apt-manifest-tree-1.0.json&quot;</span></div>
<div class="line">            ],</div>
<div class="line">            <span class="stringliteral">&quot;handlerProperties&quot;</span>: {</div>
<div class="line">                <span class="stringliteral">&quot;installedCriteria&quot;</span>: <span class="stringliteral">&quot;apt-update-test-tree-2.2&quot;</span></div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    ]</div>
<div class="line">},</div>
<div class="line"><span class="stringliteral">&quot;manifestVersion&quot;</span>: <span class="stringliteral">&quot;4.0&quot;</span>,</div>
<div class="line"><span class="stringliteral">&quot;importedDateTime&quot;</span>: <span class="stringliteral">&quot;...&quot;</span>,</div>
<div class="line"><span class="stringliteral">&quot;createdDateTime&quot;</span>: <span class="stringliteral">&quot;...&quot;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md125"></a>
The Steps Handler</h1>
<p>As mentioned earlier on this page, the top level (parent) Update Manifest does not contains <code>Update Type</code>, an Agent Workflow will implicitly assign a type called <code>microsoft/step:1</code>, and automatically load the Steps Handler (libmicrosoft_steps_1.so) to process this Parent Update Manifest (and if available the Child Update Manifest as well, which will be demonstrated later in this document).</p>
<p>It's worth noting that, for Parent Update, the Steps Handler will iterates through every step. For each step, the handler will perform 'download', 'install', and 'apply' actions, in the exact order. Unless an error occurs, in which case, the workflow will be aborted and the <code>ResultCode</code>, <code>ExtendedResultCode</code>, and <code>ResultDetails</code> will be reported to the cloud accordingly.</p>
<p><b>Figure 1</b> - High-Level Overview of Steps Handler Sequence Diagram</p>
<p>&gt;**Note** - for simplification, the following diagram demonstrates a workflow sequence without 'cancel' action and errors.</p>
<p><object type="image/svg+xml" data="./assets/steps-handler-basic-sequence-overview.svg" style="pointer-events: none;">Steps Handler Sequence Diagram</object></p>
<h1><a class="anchor" id="autotoc_md126"></a>
A Reference Step</h1>
<p>A <b>Reference Step</b> is a step that contains Update Identifier of another Update, called <code>Child Update</code>. When processing a Reference Step, Steps Handler will download a Detached Update Manifest file specified in the Reference Step data, then validate the file integrity.</p>
<p>Next, Steps Handler will parse the Child Update Manifest and create ADUC_Workflow object (aka. Child Workflow Data) by combining the data from Child Update Manifest and File URLs information from the Parent Update Manifest. This Child Workflow Data also has a 'level' property set to '1'.</p>
<blockquote class="doxtable">
<p>Note: For Update Manifest version v4, the Child Update cannot contain any Reference Steps. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md127"></a>
Handling Reference Steps (Child Updates)</h1>
<p><b>Figure 2</b> - Overview of Steps Handler Sequence Diagram With Parent and Child Updates</p>
<p><object type="image/svg+xml" data="./assets/steps-handler-child-update-sequence-overview.svg" style="pointer-events: none;">Steps Handler Sequence Diagram - Parent and Child</object></p>
<h2><a class="anchor" id="autotoc_md128"></a>
Things To Know</h2>
<ul>
<li>To deliver an update to a component or group of components connected to a Host Device, the step must be <code>Reference Step</code>. The <code>compatibility</code> property will be used for selecting target components.<br  />
<br  />
See ../../extensions/component_enumerators/examples/contoso_component_enumerator/README.md "Contoso Component Enumerator Example" for more details about components selection process.</li>
<li>Parent Update's inline steps will be applied to Host Device only.</li>
<li>Only Parent Update can contains Reference Step.</li>
<li>Only one level of referencing is allowed. A Child Update cannot contains any reference steps.</li>
</ul>
<h1><a class="anchor" id="autotoc_md129"></a>
Related Topics</h1>
<ul>
<li>../../../docs/agent-reference/how-to-implement-custom-update-handler.md.md "How To Implement Custom Step  Handler"</li>
<li>../../../docs/agent-reference/multi-component-updating.md "Multi Component Updating"</li>
<li>../../extensions/component_enumerators/examples/contoso_component_enumerator/README.md "Contoso Component Enumerator Example"</li>
<li><a href="../../../docs/agent-reference/update-manifest-v4-schema.md#multi-step-ordered-execution-msoe-support">What's MSOE</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
