<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Device Update for IotHub: SWUpdate Handler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Device Update for IotHub
   &#160;<span id="projectnumber">1.0.1</span>
   </div>
   <div id="projectbrief">Device Update for IoTHub delivers client update from the Device Update for IotHub service.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">SWUpdate Handler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md101"></a>
What is SWUpdate?</h1>
<p><a href="https://github.com/sbabic/swupdate">SWUpdate</a> is a Linux Update agent with the goal to provide an efficient and safe way to update an embedded Linux system in field. SWUpdate supports local and OTA updates, multiple update strategies and it is designed with security in mind.</p>
<h1><a class="anchor" id="autotoc_md102"></a>
What is SWUpdate Handler?</h1>
<p>SWUpdate Handler is a Device Update Agent extension that provides a local software update capability on an embedded device with payloads delivered over the air via Device Update for IoT Hub.</p>
<p>See ../../../../docs/agent-reference/how-to-implement-custom-update-handler.md "How To Implement A Custom Step Handler Extension" for more information.</p>
<h1><a class="anchor" id="autotoc_md103"></a>
SWUpdate Handler Goals</h1>
<p>While SWUpdate supports many features (see <a href="https://github.com/sbabic/swupdate#features">SWUpdate feature list</a> ), the main goals of this SWUpdate Handler are to demonstrate:</p>
<ul>
<li>how to perform A/B system update on an embedded linux device.</li>
<li>how to execute SWUpdate command, with pass-through options, on an embedded linux device.</li>
<li>how to deliver multiple .swu files to a device, then install those files onto multiple peripherals.</li>
</ul>
<blockquote class="doxtable">
<p>NOTE | for A/B system update, most of the example scripts and update artifacts in this document will used to demonstrate how to deliver an update to a Raspberry Pi device that running a sample reference Yocto (warrior) image with built-in Device Update Agent service. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md104"></a>
Architecture</h1>
<h2><a class="anchor" id="autotoc_md105"></a>
High-level Overview of Device Update Agent Workflow</h2>
<p><object type="image/svg+xml" data="./images/highlevel-overview-swupdate-handler-workflow.svg" style="pointer-events: none;">SWUpdate Handler Overview Diagram</object></p>
<h1><a class="anchor" id="autotoc_md106"></a>
How To Use SWUpdate Handler</h1>
<h2><a class="anchor" id="autotoc_md107"></a>
Registering SWUpdate Handler extension</h2>
<p>To enable SWUpdate on the device, the handler must be registered to support **'microsoft/swupdate:2'**.</p>
<p>Note that this version of SWUpdate Handler is different from the previous version published as part of the 2022 Public Preview Refresh release. The new handler is not backward compatible with previous versions. Hence, we recommend using a new update-type (**'microsoft/swupdate:2'**)</p>
<p>Following command can be run manually on the device:</p>
<div class="fragment"><div class="line">sudo /usr/bin/AducIotAgent --update-type &#39;microsoft/swupdate:2&#39; --register-content-handler &lt;full path to the handler file&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md108"></a>
Setting SWUpdate Handler Properties</h2>
<p>Using [Multi Step Ordered Exeuction (MSOE)](), you can create a step that perform various swupdate tasks on the embedded device.</p>
<p>The SWUpdate Handler support following handler properties (<code>handlerProperties</code>) :</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name </th><th class="markdownTableHeadNone">Type </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">scriptFileName </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">Name of a script file that perform additional logics related to A/B system update. This property should be specified only when performing A/B System Update.<br  />
<br  />
 See <a href="#ab-update-script">A/B Update Script</a> below for more information.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">arguments </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">A space delimited options and arguments that will be passed directly to SWUpdate command.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">installedCriteria </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">String interpreted by the specified <code>scriptFileName</code> to determine if the update completed successfully. <br  />
 This value will be passed to the underlying update script in this format: <code>--installed-criteria &lt;value&gt;</code>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">apiVersion </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">An API version. Default value is &lt;<em>empty</em>&gt; which implies "1.0". Current supported value is 1.0" and "1.1".  </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md109"></a>
List of Supported handlerProperties.arguments</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name </th><th class="markdownTableHeadNone">Type </th><th class="markdownTableHeadNone">Required </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;swu-file </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">yes </td><td class="markdownTableBodyNone">Name of the image or software (.swu) file to be installed by swupdate.  </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md110"></a>
List of SWUpdate runtime options</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name </th><th class="markdownTableHeadNone">Type </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;work-folder </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">Full path to a work (sandbox) folder used by an Agent when performing update-related tasks.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;output-file </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">Full path to an output file that swupdate script should write to  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;log-file </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">Full path to a log file that swupdate script should write to. (This is different that Agent's log file)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;result-file </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">Full path to an ADUC_Result file that swupdate script must write the end result of the update tasks to. If this file does not exist or cannot be parsed, the task will be considered failed.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;action-download,<br  />
&ndash;action-install,<br  />
&ndash;action-apply,<br  />
&ndash;action-cancel,<br  />
&ndash;action-is-installed </td><td class="markdownTableBodyNone">(no arguments) </td><td class="markdownTableBodyNone">An option indicates the current update task.<br  />
<br  />
**NOTE:** If **"apiVersion"** set to **"1.1"**, the handler will pass following arguments instead:<br  />
"--action **download**", "--action **install**", "--action **apply**", "--action **cancel**", "--action **is-installed**"  </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md111"></a>
Example: A/B Update Script</h2>
<p>In <a href="./tests/testdata/">./tests/testdata</a> folder you will find an example script file that can be invoked to perform various update related tasks, such as:</p>
<ul>
<li>download additional files.</li>
<li>install the update (.swu file).</li>
<li>apply the update (e.g., reboot the device into the updated partition)</li>
<li>cancel the update.</li>
<li>check whether the device meets an installed criteria specified in the update manifest.</li>
</ul>
<h3><a class="anchor" id="autotoc_md112"></a>
How SWUpdate Handler Invokes Update Script</h3>
<p><object type="image/svg+xml" data="./images/swupdate-script-options-and-arguments.svg" style="pointer-events: none;">SWUpdate script options and arguments</object></p>
<ol type="1">
<li>SWUpdate prepares options and arguments from the following sources:<ul>
<li>swupdate-handler-config.json (static data in .json file)</li>
<li>an agent workflow context (runtime data), such as, <code>--work-folder &lt;sandbox folder&gt;</code></li>
<li>handlerProperties.swuFileName (static data in update manifest). This value will be converted to a script option as <code>--swu-file &lt;file path&gt;</code>.</li>
<li>handlerProperties.arguments (static data in update manifest)</li>
<li>SWUpdate log, output, and result file path.</li>
</ul>
</li>
<li>SWUpdate then invoke an underlying update script as 'root' (using adu-shell as a broker).</li>
<li>After the script is completed, SWUpdate handler collects data from log file, output file, and result file, then proceed an Agent workflow accordingly.</li>
</ol>
<h3><a class="anchor" id="autotoc_md113"></a>
Evaluating 'installedCriteria'</h3>
<p>For this example, to determine whether the new image has been installed on the device successfully, the SWUpdate Handler will run the specified <code>scriptFileName</code> with &lsquo;--action is-installed &rsquo;&lt;installedCriteria&gt;'` option.</p>
<p>For example:</p>
<div class="fragment"><div class="line">/adu/downloads/workflow-01234567/example-a-b-update.sh --action is-installed --installed-criteria &#39;8.0.1.0001&#39;</div>
</div><!-- fragment --><p>In this <a href="./tests/testdata/adu-yocto-ab-rootfs-update/example-a-b-update-2.1.sh">example update script</a>, it simply compares the given 'installedCriteria' value (8.0.1.0001) to a content of <code>adu-version</code> file (located at /etc/adu-version folder).</p>
<p>The algorithm for evaluating <code>installedCriteria</code> can be 100% customized to fit your device design and requirements. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
