<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Device Update for IotHub: Script Handler Extension</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Device Update for IotHub
   &#160;<span id="projectnumber">1.0.1</span>
   </div>
   <div id="projectbrief">Device Update for IoTHub delivers client update from the Device Update for IotHub service.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Script Handler Extension </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Script Handler Extension (or, in short, <b>Script Handler</b>) handler can be used to prepare and execute a script on the IoT Device.</p>
<h1><a class="anchor" id="autotoc_md81"></a>
Overview</h1>
<p>For some update scenarios, you may want to run additional set of commands before, during, or after, installing a software update on your device. This can be achieved using an <b>Inline Step</b> with <code>microsoft/script:1</code> handler type.</p>
<p>By default, Device Update Agent workflow invokes <b>Script Handler</b> to process <code>microsoft/script:/1</code> steps.</p>
<blockquote class="doxtable">
<p>For more information about <b>Inline Step</b>, see ../../../docs/agent-reference/update-manifest-v4-schema.md "Update Manifest V4 Schema" </p>
</blockquote>
<p><b>Script Handler</b> key concepts include:</p>
<ul>
<li>execute a custom script that's delivered to a device as an update payload.</li>
<li>pass option(s) and argument(s) specified in an Update Manifest to the script at runtime.</li>
<li>pass Device Update Agent workflow information to the script at runtime. Component Data to the script at runtime.</li>
<li>gather result (ADUC_Result data) of the script execution then report back to the Device Update Agent workflow.</li>
<li>communicate the Script's desired action (e.g., restart the Agent process, reboot the device) back to the Device Update Agent workflow.</li>
<li>gather error and informational logs generated from the script execution then report back to the Device Update Agent workflow.</li>
</ul>
<h2><a class="anchor" id="autotoc_md82"></a>
High-Level Update Flow</h2>
<p><object type="image/svg+xml" data="./images/script-handler-overview.svg" style="pointer-events: none;">Script Handler Overview Diagram</object></p>
<h1><a class="anchor" id="autotoc_md83"></a>
Understanding How Script Handler Communicates with the Script</h1>
<h2><a class="anchor" id="autotoc_md84"></a>
Example Update Manifest</h2>
<blockquote class="doxtable">
<p>NOTE | For demonstration purposes, we will use following Update Manifest data as an example throughout this document. </p>
</blockquote>
<p>The following update contains 3 in-line steps (in <code>instructions.steps</code> array) :</p>
<ul>
<li>Pre-install step</li>
<li>Firmware installation step</li>
<li>Post-install step</li>
</ul>
<p>All 3 steps are handled by Script Handler, as indicated by <code>"handler":"microsoft/script:1"</code> in each step data.</p>
<p>&gt;NOTE | Device Update agent will dynamically load a registered <b>Update Handler</b> for a <b>Handler Type</b> (also known as <b>Update Type</b>) specified in <code>handler</code> property. The Script Handler provided in the project will be registered to handle <code>microsoft/script:1</code> update type by default as part of <b>deviceupdate-agent</b> <a class="el" href="classAPT.html" title="Exception throw by APT Parser.">APT</a> package installation.</p>
<h3><a class="anchor" id="autotoc_md85"></a>
Example Update Manifest JSON Data</h3>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;updateId&quot;: {</div>
<div class="line">        &quot;provider&quot;: &quot;contoso&quot;,</div>
<div class="line">        &quot;name&quot;: &quot;Virtual-Vacuum-virtual-motors&quot;,</div>
<div class="line">        &quot;version&quot;: &quot;3.0&quot;</div>
<div class="line">    },</div>
<div class="line">    &quot;isDeployable&quot;: false,</div>
<div class="line">    &quot;compatibility&quot;: [</div>
<div class="line">        {</div>
<div class="line">            &quot;group&quot;: &quot;motors&quot;</div>
<div class="line">        }</div>
<div class="line">    ],</div>
<div class="line">    &quot;instructions&quot;: {</div>
<div class="line">        &quot;steps&quot;: [</div>
<div class="line">            {</div>
<div class="line">                &quot;description&quot;: &quot;Motors Update pre-install step&quot;,</div>
<div class="line">                &quot;handler&quot;: &quot;microsoft/script:1&quot;,</div>
<div class="line">                &quot;files&quot;: [</div>
<div class="line">                    &quot;contoso-motor-installscript.sh&quot;</div>
<div class="line">                ],</div>
<div class="line">                &quot;handlerProperties&quot;: {</div>
<div class="line">                    &quot;scriptFileName&quot;: &quot;contoso-motor-installscript.sh&quot;,</div>
<div class="line">                    &quot;arguments&quot;: &quot;--pre-install-sim-success --component-name --component-name-val --component-group --component-group-val --component-prop path --component-prop-val path&quot;,</div>
<div class="line">                    &quot;installedCriteria&quot;: &quot;1.2&quot;</div>
<div class="line">                }</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;description&quot;: &quot;Motors Update - firmware installation&quot;,</div>
<div class="line">                &quot;handler&quot;: &quot;microsoft/script:1&quot;,</div>
<div class="line">                &quot;files&quot;: [</div>
<div class="line">                    &quot;contoso-motor-installscript.sh&quot;,</div>
<div class="line">                    &quot;motor-firmware-1.2.json&quot;</div>
<div class="line">                ],</div>
<div class="line">                &quot;handlerProperties&quot;: {</div>
<div class="line">                    &quot;scriptFileName&quot;: &quot;contoso-motor-installscript.sh&quot;,</div>
<div class="line">                    &quot;arguments&quot;: &quot;--firmware-file motor-firmware-1.2.json --component-name --component-name-val --component-group --component-group-val --component-prop path --component-prop-val path&quot;,</div>
<div class="line">                    &quot;installedCriteria&quot;: &quot;1.2&quot;</div>
<div class="line">                }</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;description&quot;: &quot;Motors Update post-install step&quot;,</div>
<div class="line">                &quot;handler&quot;: &quot;microsoft/script:1&quot;,</div>
<div class="line">                &quot;files&quot;: [</div>
<div class="line">                    &quot;contoso-motor-installscript.sh&quot;</div>
<div class="line">                ],</div>
<div class="line">                &quot;handlerProperties&quot;: {</div>
<div class="line">                    &quot;scriptFileName&quot;: &quot;contoso-motor-installscript.sh&quot;,</div>
<div class="line">                    &quot;arguments&quot;: &quot;--post-install-sim-success --component-name --component-name-val --component-group --component-group-val --component-prop path --component-prop-val path&quot;,</div>
<div class="line">                    &quot;installedCriteria&quot;: &quot;1.2&quot;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        ]</div>
<div class="line">    },</div>
<div class="line">    &quot;referencedBy&quot;: [</div>
<div class="line">        {</div>
<div class="line">            &quot;provider&quot;: &quot;Contoso&quot;,</div>
<div class="line">            &quot;name&quot;: &quot;Virtual-Vacuum&quot;,</div>
<div class="line">            &quot;version&quot;: &quot;5.0&quot;</div>
<div class="line">        }</div>
<div class="line">    ],</div>
<div class="line">    &quot;manifestVersion&quot;: &quot;4.0&quot;,</div>
<div class="line">    &quot;scanResult&quot;: &quot;Success&quot;,</div>
<div class="line">    &quot;importedDateTime&quot;: ...,</div>
<div class="line">    &quot;bundledBy&quot;: [...],</div>
<div class="line">    &quot;createdDateTime&quot;: ...,</div>
<div class="line">    &quot;etag&quot;: ...</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md86"></a>
Handler Properties Requirements</h1>
<p>The current implementation of the Script Handler requires following values in the <code>handlerProperties</code> map:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Key </th><th class="markdownTableHeadNone">Value </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">scriptFileName </td><td class="markdownTableBodyNone">Name of the script file </td><td class="markdownTableBodyNone">This file must be imported as part of the update. The file will be downloaded into a working folder on the device, when Device Update agent processing the update.<br  />
<br  />
 See <a href="#specify-a-script-filename">Specify A Script Filename</a> for more details.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">arguments </td><td class="markdownTableBodyNone">Space-delimited list of options and arguments to pass to the script file when executing the step </td><td class="markdownTableBodyNone">There are a <b>reserved options and arguments</b> that Script Handler appends to the list, at runtime. <br  />
<br  />
 For script that support <b>Multi-Component Update</b>, the <b>reserved component-related</b> options can be specified in the <code>handlerProperties.arguments</code>. These options will be processed by the Script Handler, and replaced with the runtime values for a <code>component</code> being updated.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">installedCriteria </td><td class="markdownTableBodyNone">A string interpreted by the handler to determine whether the <b>Step</b> need to be processed. </td><td class="markdownTableBodyNone">Script Handler pass the responsibility to determine whether the <b>Step</b> has been <b>completed</b> (aka., installed) by passing this <code>installedCriteria</code> string to the script.  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md87"></a>
Specify A Script Filename</h1>
<p>From an <a href="#example-update-manifest-json-data">example steps data</a> above, notice the <code>handlerProperties.scriptFileName</code> property values, which are the same as file names in <code>files</code> array.</p>
<p>At runtime, the Script Handler will download every files listed in <code>files</code> array, into a <code>workfolder</code> (e.g., **/var/lib/adu/downloads/workflow_id_1234567890/**).</p>
<p>&gt;**Note** | Learn more about how the Script Handler passes <code>workfolder</code> path to the script in <a href="#default-workflow-options-and-arguments">Default Workflow Options and Arguments</a> section below.</p>
<p>Later on, the Script Handler will invoke the specified script file, in a forked-process, to perform various tasks, such as <code>download</code> (additional file), <code>install</code> an update, <code>apply</code> the installed update, <code>cancel</code> the update flow if needed, or perform <code>is-installed</code> evaluation.</p>
<blockquote class="doxtable">
<p><b>IMPORTANT</b> | Whatever file is referenced in the update manifest will be run as <code>root</code>! If you do not wish to enable this behavior, then you can modify <code>adu-shell</code> to run the file as other user. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md88"></a>
Passing Arguments To Script</h1>
<p>You can specify the script argument in &lsquo;handlerProperties.arguments&rsquo; property of the <b>In-line Step</b> (see <a href="https://docs.microsoft.com/en-us/azure/iot-hub-device-update/update-manifest">Update Manifest</a> for more information about Multi-Step Ordered Execution and different between <b>In-line</b> vs. <b>Reference</b> steps)</p>
<p>For example (see <b>arguments</b> value below):</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;description&quot;: &quot;Motors Update post-install step&quot;,</div>
<div class="line">    &quot;handler&quot;: &quot;microsoft/script:1&quot;,</div>
<div class="line">    &quot;files&quot;: [</div>
<div class="line">        &quot;contoso-motor-installscript.sh&quot;</div>
<div class="line">    ],</div>
<div class="line">    &quot;handlerProperties&quot;: {</div>
<div class="line">        &quot;scriptFileName&quot;: &quot;contoso-motor-installscript.sh&quot;,</div>
<div class="line">        &quot;arguments&quot;: &quot;--post-install-sim-success --component-name --component-name-val --component-group --component-group-val --component-prop path --component-prop-val path&quot;,</div>
<div class="line">        &quot;installedCriteria&quot;: &quot;1.2&quot;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md89"></a>
Arguments Value Format</h2>
<p>The <code>arguments</code> value contains a space-delimited <code>options</code> and <code>arguments</code> that will be processed by the Script Handler. These <code>options</code> may be interpreted by the Script Handler, then, replaced by, or populated with runtime variables.</p>
<p>Additionally, the Script Handler will append some default runtime workflow related values, such as, <code>workfolder</code>, <code>result-file</code>, <code>installed-criteria</code>, etc. to the options and arguments list.</p>
<p>You can specify any options and arguments that relevant to the script in this 'arguments' string, as long as they don't conflict with <a href="#reserved-options">reserved options</a> or <a href="#default-workflow-options-and-arguments">default workflow runtime options and arguments</a> listed below.</p>
<h2><a class="anchor" id="autotoc_md90"></a>
Reserved Options</h2>
<p>You can specify any argument in the <code>handlerProperties.arguments</code> string, except the <a href="#default-workflow-options-and-arguments">default workflow options and arguments</a> and <a href="#options-for-components-runtime-variables">options for component runtime variables</a> listed in tables below:</p>
<blockquote class="doxtable">
<p><b>IMPORTANT</b>: Specify these options in the <code>handlerProperties.arguments</code> string may cause an unexpected behavior. </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md91"></a>
Default Workflow Options and Arguments</h3>
<p>The following options and arguments are automatically pass to the script.</p>
<blockquote class="doxtable">
<p><b>IMPORTANT</b>: Specify these options in the <code>handlerProperties.arguments</code> string may cause an unexpected behavior: </p>
</blockquote>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Options </th><th class="markdownTableHeadNone">Argument(s) </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;action-apply </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">Script Handler will append this option to the <code>arguments</code> list to indicate that the script is invoked as part of the <code>apply</code> action.<br  />
The Script should perform any additional tasks that finalize the installation of the update.<br  />
 For example, for SWUpdate flow, the <code>install</code> action may involve files copy and bootloader configurations changes. The <code>apply</code> action may involve device restart, using the boot partition which contains the new version of the OS.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;action-cancel </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">Script Handler will append this option to the <code>arguments</code> list to indicate that the update (step) is being canceled.<br  />
The Script should consider canceling any in-progress task, and restore the device or component back to the original state.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;action-download </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">Script Handler will append this option to the <code>arguments</code> list to indicate that the script is invoked as part of the <code>download</code> action.<br  />
The Script should perform any additional content download tasks to ensure that all content required by the installation is accessible during the installation.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;action-install </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">Script Handler will append this option to the <code>arguments</code> list to indicate that the script is invoked as part of the <code>install</code> action.<br  />
The Script should perform all tasks related to the software installation. Such as, install a software package(s) on host device, transfer firmware file to connected peripheral, remove existing file(s) that no longer needed, etc.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;action-is-installed </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">Script Handler will append this option to the <code>arguments</code> list to indicate that the script is invoked as part of the <code>isInstalled</code> inquiry.<br  />
As part of the Agent-Orchestrated workflow, sometimes, Device Update Agent will invoke the Script Handler's <code>IsInstalled</code> function to determine wither the current Step has been <b>installed</b>. <br  />
 For Step that does not install any software, <b>is installed</b> is equivalent to <b>applied</b>. E.g., "Is the step has been applied on the device or components?"  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;work-folder </td><td class="markdownTableBodyNone">&lt;"work_folder_path"&gt; </td><td class="markdownTableBodyNone">A fully qualified path to <code>workfolder</code> (a.k.a. <code>sandbox folder</code>). This is a folder used for storing downloaded file, workflow result file, and any other temp files.<br  />
<br  />
Script Handler will append this option to the arguments list when invoking the script.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;result-file </td><td class="markdownTableBodyNone">&lt;"result_file_path"&gt; </td><td class="markdownTableBodyNone">A fully qualified path to the workflow task result. The result file contains a ADUC_Result data in a JSON. The Script Handler will read ADUC_Result data in this file and continue or abort the update workflow based on the <code>resultCode</code>. If the result file does not exist, or can not be opened, the update workflow will be aborted.<br  />
<br  />
Script Handler will append this option to the arguments list when invoking the script.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;installed-criteria </td><td class="markdownTableBodyNone">&lt;"installed_criteria_string"&gt; </td><td class="markdownTableBodyNone">Pass-through value to the script.  </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md92"></a>
Options for Components Runtime Variables</h3>
<p>The following options are reserved, and will be replaced by component-related value(s) at runtime. They are useful when implementing script that is support multi-component updates, which often perform various component(s)-specific tasks.</p>
<p>For example:</p>
<ul>
<li>Copy files to a specific device path</li>
<li>Install firmware for a specific device name</li>
<li>Install firmware for a group of device</li>
</ul>
<blockquote class="doxtable">
<p><b>NOTE</b> | The following arguments will be replaced by **"n/a"** if <code>Component Enumerator Extension</code> is not registered. </p>
</blockquote>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Options </th><th class="markdownTableHeadNone">Arguments </th><th class="markdownTableHeadNone">Runtime Value Type </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;component-id-val </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">The current components' id  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;component-name-val </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">The current component's name  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;component-manufacturer-val </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">The component's manufacturer  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;component-model-val </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">The component's model  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;component-version-val </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">The component's version  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;component-group-val </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">The component's group  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;component-prop-val </td><td class="markdownTableBodyNone">property name </td><td class="markdownTableBodyNone">string </td><td class="markdownTableBodyNone">The components' property value.<br  />
<br  />
**NOTE:** The argument must follow by a component's property name.  </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md93"></a>
Example - specify component-related options and arguments</h3>
<p>The following instruction step contains various reserved options that would be replaced by component-related runtime variables, after processed by the Script Handler.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;description&quot;: &quot;Motors Update - firmware installation&quot;,</div>
<div class="line">    &quot;handler&quot;: &quot;microsoft/script:1&quot;,</div>
<div class="line">    &quot;files&quot;: [</div>
<div class="line">        &quot;contoso-motor-installscript.sh&quot;,</div>
<div class="line">        &quot;motor-firmware-1.2.json&quot;</div>
<div class="line">    ],</div>
<div class="line">    &quot;handlerProperties&quot;: {</div>
<div class="line">        &quot;scriptFileName&quot;: &quot;contoso-motor-installscript.sh&quot;,</div>
<div class="line">        &quot;arguments&quot;: &quot;--firmware-file motor-firmware-1.2.json --component-name --component-name-val --component-group --component-group-val --component-prop path --component-prop-val path&quot;,</div>
<div class="line">        &quot;installedCriteria&quot;: &quot;1.2&quot;</div>
<div class="line">    }</div>
<div class="line">},</div>
</div><!-- fragment --><p>Following are the mapping between the <code>step.handlersProperties.arguments</code> value and the actual arguments that <b>StepHandler</b> pass to the script at runtime. </p><blockquote class="doxtable">
<p>Note: for this example, let's assumed that the Script Handler is processing an update workflow (<code>install</code>) for following component information provided by a registered <code>Component Enumerator</code> extension </p>
</blockquote>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;components&quot;: [</div>
<div class="line"> </div>
<div class="line">        ...,</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">            &quot;id&quot;: &quot;contoso-motor-serial-00000&quot;,</div>
<div class="line">            &quot;name&quot;: &quot;left-motor&quot;,</div>
<div class="line">            &quot;group&quot;: &quot;motors&quot;,</div>
<div class="line">            &quot;manufacturer&quot;: &quot;contoso&quot;,</div>
<div class="line">            &quot;model&quot;: &quot;virtual-motor&quot;,</div>
<div class="line">            &quot;properties&quot;: {</div>
<div class="line">                &quot;path&quot;: &quot;\/usr\/local\/contoso-devices\/vacuum-1\/motors\/contoso-motor-serial-00000&quot;,</div>
<div class="line">                &quot;firmwareDataFile&quot;: &quot;firmware.json&quot;,</div>
<div class="line">                &quot;status&quot;: &quot;ok&quot;</div>
<div class="line">            },</div>
<div class="line">            &quot;version&quot;: &quot;1.2&quot;,</div>
<div class="line">            &quot;description&quot;: &quot;This component is generated for testing purposes.&quot;</div>
<div class="line">        },</div>
<div class="line"> </div>
<div class="line">        ...</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">handleProperties.arguments<br  />
(option) </th><th class="markdownTableHeadNone">handleProperties.arguments<br  />
(arguments) </th><th class="markdownTableHeadNone">Value pass to the script at runtime<br  />
(<em>after processed by Script Handler</em>) </th><th class="markdownTableHeadNone">Note  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;firmware-file motor-firmware-1.2.json </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">&ndash;firmware-file motor-firmware-1.2.json </td><td class="markdownTableBodyNone">Not a reserved option.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone" colspan="2">&ndash;component-name </td><td class="markdownTableBodyNone">&ndash;component-name </td><td class="markdownTableBodyNone">Not a reserved option.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone" colspan="2">&ndash;component-name-val </td><td class="markdownTableBodyNone">**"left-motor"** </td><td class="markdownTableBodyNone">This is the value of the component's <b>name</b> property above.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone" colspan="2">&ndash;component-group </td><td class="markdownTableBodyNone">&ndash;component-group </td><td class="markdownTableBodyNone">Not a reserved option.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone" colspan="2">&ndash;component-group-val </td><td class="markdownTableBodyNone">**"motors"** </td><td class="markdownTableBodyNone">This is the value of the component's <b>group</b> property above.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">&ndash;component-prop </td><td class="markdownTableBodyNone">path </td><td class="markdownTableBodyNone">&ndash;component-prop path </td><td class="markdownTableBodyNone">Not a reserved option. Note that both option and argument are unchanged.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;component-prop-val </td><td class="markdownTableBodyNone">path </td><td class="markdownTableBodyNone">**"\/usr\/local\/contoso-devices\/vacuum-1\/motors\/contoso-motor-serial-00000"** </td><td class="markdownTableBodyNone">This is the value of the component's <b>properties.path</b> value above.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone" colspan="2"></td><td class="markdownTableBodyNone"><em><b>&ndash;action-install</b></em> </td><td class="markdownTableBodyNone">Automatically appended as part of the *<code>*install*</code>* workflow. This indicates that the script should perform 'install' task.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone" colspan="2"></td><td class="markdownTableBodyNone"><b>&ndash;work-folder</b> **"/var/lib/adu/downloads/workflow_id_1234567890/"** </td><td class="markdownTableBodyNone">Automatically appended as part of the *<code>*install*</code>* workflow. Note that is is for demonstration purposes. The actual work folder path will be different in real update scenario.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone" colspan="2"></td><td class="markdownTableBodyNone"><b>&ndash;result-file</b> **"/var/lib/adu/downloads/workflow_id_1234567890/aduc_result.json"** </td><td class="markdownTableBodyNone">Automatically appended as part of the *<code>*install*</code>* workflow. Note that is is for demonstration purposes. The actual file path will be different in real update scenario.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone" colspan="2"></td><td class="markdownTableBodyNone"><b>&ndash;installed-criteria</b> **"2.0"** </td><td class="markdownTableBodyNone">Automatically appended as part of the *<code>*install*</code>* workflow. The value **"2.0"** is the value of <code>handlerProperties.installedCriteria</code>, if specified.  </td></tr>
</table>
<p>From the post-processed values in the table above, this is what the script invoking command looks like:</p>
<div class="fragment"><div class="line">contoso-motor-installscript.sh</div>
<div class="line">    --firmware-file motor-firmware-1.2.json</div>
<div class="line">    --component-name &quot;left-motor&quot; --component-group &quot;motors&quot;</div>
<div class="line">    --component-prop path &quot;/usr/local/contoso-devices/vacuum-1/motors/contoso-motor-serial-00000&quot;</div>
<div class="line">    --action-install</div>
<div class="line">    --work-folder &quot;/var/lib/adu/downloads/workflow_id_1234567890/&quot;</div>
<div class="line">    --result-file &quot;/var/lib/adu/downloads/workflow_id_1234567890/aduc_result.json&quot;</div>
<div class="line">    --installed-criteria&quot;: &quot;1.2&quot;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md94"></a>
Example Script</h2>
<p>To get started, you can take a look at the <a href="./examples/example-installscript.sh">example-installscript.sh</a> to see how the script can be implemented.</p>
<blockquote class="doxtable">
<p>IMPORTANT: Please note that this is for demonstration purposes only. The example script is provided AS-IS. You should not use it for your production project. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md95"></a>
Communicating the script execution result back to the Script Handler</h2>
<p>The script, must write an ADUC_Result data into a designated result file (specified by &ndash;result-file option)</p>
<blockquote class="doxtable">
<p>IMPORTANT: Make sure to modify the default behavior of writing result file. If agent detects ResultCode and ExtendedResultCode of 0, then for discoverability, it will replace the ExtendedResultCode with ADUC_ERC_SCRIPT_HANDLER_INSTALL_FAILURE_SCRIPT_RESULT_EXTENDEDRESULTCODE_ZERO that has numeric code of 81054976 (decimal) and 0x30500206 (hexadecimal). </p>
</blockquote>
<p>Example contents of result file for Success:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;resultCode&quot;: 1,</div>
<div class="line">    &quot;extendedResultCode&quot;: 0,</div>
<div class="line">    &quot;resultDetails&quot;: &quot;&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Example contents of result file for Failure:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;resultCode&quot;: 0,</div>
<div class="line">    &quot;extendedResultCode&quot;: &lt;some non-zero decimal number&gt;,</div>
<div class="line">    &quot;resultDetails&quot;: &quot;some optional description&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md96"></a>
Example</h3>
<p>The following is excerpt from an example script:</p>
<div class="fragment"><div class="line">...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">#</div>
<div class="line"># Write result json string to result file.</div>
<div class="line">#</div>
<div class="line">result(){</div>
<div class="line">    # NOTE: don&#39;t insert timestamp in result file.</div>
<div class="line">    if [ -z $result_file ]; then</div>
<div class="line">        echo &quot;$@&quot; &gt;&amp;1</div>
<div class="line">    else</div>
<div class="line">        echo &quot;$@&quot; &gt; &quot;$result_file&quot;</div>
<div class="line">    fi</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">#</div>
<div class="line"># Perform install-related tasks.</div>
<div class="line">#</div>
<div class="line">InstallUpdate() {</div>
<div class="line">    resultCode=0</div>
<div class="line">    extendedResultCode=0</div>
<div class="line">    resultDetails=&quot;&quot;</div>
<div class="line">    ret_val=0</div>
<div class="line"> </div>
<div class="line">    #</div>
<div class="line">    # PLACEHOLDER : Evaluate &#39;installCriteria&#39; to determine if there is anything to do.</div>
<div class="line">    #               If not, return ADUC_Result_Install_Success (600). Otherwise, continue.</div>
<div class="line">    #</div>
<div class="line"> </div>
<div class="line">    #</div>
<div class="line">    # PLACEHOLDER : Perform installation tasks here.</div>
<div class="line">    #</div>
<div class="line">    #               Based on overall result..</div>
<div class="line">    #</div>
<div class="line">    #               # Set result code and details</div>
<div class="line">    #               resultCode=&lt;Result Code&gt;</div>
<div class="line">    #               extendedResultCode=&lt;Extended Result Code, in case of error&gt;</div>
<div class="line">    #               resultDetails=&quot;&lt;Additional result details&gt;</div>
<div class="line">    #               $ret_value=&lt;Script exit code&gt;</div>
<div class="line"> </div>
<div class="line">    # Prepare ADUC_Result json.</div>
<div class="line">    aduc_result_json=&quot;{\&quot;resultCode\&quot;:$resultCode, \&quot;extendedResultCode\&quot;:$extendedResultCode,\&quot;resultDetails\&quot;:\&quot;$resultDetails\&quot;}&quot;</div>
<div class="line"> </div>
<div class="line">    # Write ADUC_Result to result file.</div>
<div class="line">    result  &quot;$aduc_result_json&quot;</div>
<div class="line"> </div>
<div class="line">    $ret $ret_val</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">...</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
