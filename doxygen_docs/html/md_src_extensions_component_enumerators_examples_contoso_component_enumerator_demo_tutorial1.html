<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Device Update for IotHub: TUTORIAL - OTA Multi Component Update Using APT Handler and Script Handler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Device Update for IotHub
   &#160;<span id="projectnumber">1.0.1</span>
   </div>
   <div id="projectbrief">Device Update for IoTHub delivers client update from the Device Update for IotHub service.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">TUTORIAL - OTA Multi Component Update Using <a class="el" href="classAPT.html" title="Exception throw by APT Parser.">APT</a> Handler and Script Handler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md23"></a>
Scenario</h1>
<p>Contoso wants to update all Virtual Vacuum devices by delivering OTA update to accomplish following goals:</p>
<ul>
<li>Install the latest <code>tree</code> Debian package on the <code>host</code> device</li>
<li>Install the <code>Virtual Motor</code> firmware version 1.1 to all Virtual Motors that currently connected to the <code>host</code> device</li>
</ul>
<h1><a class="anchor" id="autotoc_md24"></a>
Device Information</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Property </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Manufacturer </td><td class="markdownTableBodyNone"><b>contoso</b>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Model </td><td class="markdownTableBodyNone"><b>virtual-vacuum-v1</b>  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md25"></a>
Update Identifier</h1>
<p>At this time, this update is version 20 in their <code>update line of service</code>. The following are required values for import manifest creation.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field Name </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Provider </td><td class="markdownTableBodyNone"><b>Contoso</b>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Name </td><td class="markdownTableBodyNone"><b>Virtual-Vacuum</b>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Version </td><td class="markdownTableBodyNone"><b>20</b>  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md26"></a>
Update Types and Artifacts</h1>
<h2><a class="anchor" id="autotoc_md27"></a>
For Host Update</h2>
<blockquote class="doxtable">
<p><b>NOTE</b> | The update type for <a class="el" href="classAPT.html" title="Exception throw by APT Parser.">APT</a> Update is **'microsoft/apt:1'** </p>
</blockquote>
<ul>
<li><a class="el" href="classAPT.html" title="Exception throw by APT Parser.">APT</a> Manifest file for <code>tree</code> installation (<a href="./sample-updates/data-files/APT/apt-manifest-tree-1.0.json">apt-manifest-tree-1.0.json</a>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md28"></a>
For Component (Motors) Update</h2>
<blockquote class="doxtable">
<p><b>NOTE</b> | The update type for Virtual Motor firmware is **'microsoft/script:1'** </p>
</blockquote>
<ul>
<li>Virtual Motor firmware file (<a href="./sample-updates/data-files/motor-firmware-1.1.json">motor-firmware-1.1.json</a>)</li>
<li>Virtual Motor firmware installation script (<a href="./sample-updates/scripts/contoso-motor-installscript.sh">contoso-motor-installscript.sh</a>)</li>
</ul>
<blockquote class="doxtable">
<p><b>NOTE</b> | Save all artifacts listed above to a local folder. E.g., './update-files' </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md29"></a>
Preparing Update Instructions (steps)</h1>
<blockquote class="doxtable">
<p><b>Prerequisites</b> | Read ../../../../../../tools/AduCmdlets/README.md "Device Update for IoT Hub - Scripts" to understand how to create ADU Import Manifest, and ensure that all required scripts can be run properly. </p>
</blockquote>
<p>To accomplish the goals, this update requires 2 <code>update instruction steps</code> in the Update Manifest:</p>
<ol type="1">
<li>Install an update for the host device. This step must be a top-level <code>inline step</code>.</li>
<li>install an update for components (motors) that connected to a host device. This step must be a top-level <code>reference step</code>, in order to target the update to certain group of components.</li>
</ol>
<h2><a class="anchor" id="autotoc_md30"></a>
Top-Level Step #1 - Install &lt;tt&gt;tree&lt;/tt&gt; Debian Package</h2>
<p>The following command is used to create step #1:</p>
<p>```powershell </p>
<h1><a class="anchor" id="autotoc_md31"></a>
----------------------------------------------—</h1>
<h1><a class="anchor" id="autotoc_md32"></a>
Create the first top-level step</h1>
<h1><a class="anchor" id="autotoc_md33"></a>
----------------------------------------------—</h1>
<p>$topLevelStep1 = New-AduInstallationStep &lsquo; -Handler 'microsoft/apt:1&rsquo; <code> -Files "./update-files/apt-manifest-tree-1.0.json"</code> -HandlerProperties 'installedCriteria'='apt-update-tree-1.0'} &lsquo; -Description 'Install tree Debian package on host device.&rsquo; ```</p>
<blockquote class="doxtable">
<p><b>IMPORTANT</b> | Replace **"./update-files/apt-manifest-tree-1.0.json"** above with the actual file path. </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md34"></a>
Top-Level Step #2 - Install &lt;tt&gt;Virtual Motors Firmware 1.0&lt;/tt&gt; on all &lt;tt&gt;Motor&lt;/tt&gt; components</h3>
<p>Since this update is targeting a group of components on the host device, the <code>child update</code> and a top-level <code>reference step</code> must be created. The following script snippet is used to create both child update and reference step:</p>
<p>&gt;**NOTE** | Child update identity is required. For this tutorial, we use **"contoso", "contoso-virtual-motors", "1.1"** for <code>Provider</code>, <code>Name</code>, and <code>Version</code> respectively.</p>
<p>```powershell</p>
<h1><a class="anchor" id="autotoc_md35"></a>
----------------------------------------------—</h1>
<h1><a class="anchor" id="autotoc_md36"></a>
Create a child update for all 'motor' components</h1>
<h1><a class="anchor" id="autotoc_md37"></a>
----------------------------------------------—</h1>
<p>$RefUpdateManufacturer = "contoso" $RefUpdateName = "contoso-virtual-motors" $RefUpdateVersion = "1.1"</p>
<p>$motorsFirmwareVersion = "1.1"</p>
<p>Write-Host "Preparing child update ($RefUpdateManufacturer/$RefUpdateName/$RefUpdateVersion)..."</p>
<p>$motorsUpdateId = New-AduUpdateId -Provider $RefUpdateManufacturer -Name $RefUpdateName -Version $RefUpdateVersion</p>
<h1><a class="anchor" id="autotoc_md38"></a>
This components update only apply to 'motors' group.</h1>
<p>$motorsSelector = group = 'motors' } $motorsCompat = New-AduUpdateCompatibility -Properties $motorsSelector</p>
<p>$motorScriptFile = ".\update-files\contoso-motor-installscript.sh" $motorFirmwareFile = ".\update-files\motor-firmware-$motorsFirmwareVersion.json"</p>
<p>#---------&mdash; </p>
<h1><a class="anchor" id="autotoc_md39"></a>
ADD STEP(S)</h1>
<p>#</p>
<h1><a class="anchor" id="autotoc_md40"></a>
This update contains 1 steps.</h1>
<p>$motorsInstallSteps = @()</p>
<h1><a class="anchor" id="autotoc_md41"></a>
Step #1 - install a firmware version 1.1 onto motor component.</h1>
<p>$motorsInstallSteps += New-AduInstallationStep -Handler 'microsoft/script:1' <code> -Files $motorScriptFile, $motorFirmwareFile</code> -HandlerProperties &lsquo; 'scriptFileName&rsquo;='contoso-motor-installscript.sh'; &lsquo; 'installedCriteria&rsquo;="$RefUpdateManufacturer-$RefUpdateName-$RefUpdateVersion-step-1"; <code> "arguments"="--firmware-file motor-firmware-$motorsFirmwareVersion.json --component-name --component-name-val --component-group --component-group-val --component-prop path --component-prop-val path"</code> } <code> </code> -Description 'Motors Update - firmware 1.1 installation'</p>
<h1><a class="anchor" id="autotoc_md42"></a>
---------------------------—</h1>
<h1><a class="anchor" id="autotoc_md43"></a>
Create child update manifest</h1>
<h1><a class="anchor" id="autotoc_md44"></a>
---------------------------—</h1>
<p>$childUpdateId = $motorsUpdateId $childUpdateIdStr = "$($childUpdateId.Provider).$($childUpdateId.Name).$($childUpdateId.Version)" $childPayloadFiles = $motorScriptFile, $motorFirmwareFile $childCompat = $motorsCompat $childSteps = $motorsInstallSteps</p>
<p>Write-Host "    Preparing child update manifest $childUpdateIdStr ..."</p>
<p>$childManifest = New-AduImportManifest -UpdateId $childUpdateId -IsDeployable $false <code> -Compatibility $childCompat</code> -InstallationSteps $childSteps ` -ErrorAction Stop</p>
<h1><a class="anchor" id="autotoc_md45"></a>
Create folder for manifest files and payload.</h1>
<p>$outputPath = ".\update-files" Write-Host "    Saving child manifest files and payload to $outputPath..." New-Item $outputPath -ItemType Directory -ErrorAction SilentlyContinue | Out-Null</p>
<h1><a class="anchor" id="autotoc_md46"></a>
Generate manifest files.</h1>
<p>$childManifest | Out-File "$outputPath\$childUpdateIdStr.importmanifest.json" -Encoding utf8</p>
<p># </p>
<h1><a class="anchor" id="autotoc_md47"></a>
Create a top-level reference step.</h1>
<p># $topLevelStep2 = New-AduInstallationStep <code> -UpdateId $childUpdateId</code> -Description "Motor Firmware 1.1 Update" ```</p>
<h2><a class="anchor" id="autotoc_md48"></a>
Create an Import Manifest</h2>
<p>Create a main import manifest by adding above 2 top-level steps in the main update instructions steps collection:</p>
<p>```powershell </p><h6></h6>
<h1><a class="anchor" id="autotoc_md49"></a>
Update : 20.0</h1>
<h6></h6>
<h1><a class="anchor" id="autotoc_md50"></a>
Update Identity</h1>
<p>$UpdateProvider = "Contoso" $UpdateName = "Virtual-Vacuum" $UpdateVersion = '20.0'</p>
<h1><a class="anchor" id="autotoc_md51"></a>
Host Device Info</h1>
<p>$Manufacturer = "contoso" $Model = 'virtual-vacuum-v1'</p>
<p>$parentCompat = New-AduUpdateCompatibility -Manufacturer $Manufacturer -Model $Model $parentUpdateId = New-AduUpdateId -Provider $UpdateProvider -Name $UpdateName -Version $UpdateVersion $parentUpdateIdStr = "$($parentUpdateId.Provider).$($parentUpdateId.Name).$($parentUpdateId.Version)"</p>
<h1><a class="anchor" id="autotoc_md52"></a>
---------------------------------------------------—</h1>
<h1><a class="anchor" id="autotoc_md53"></a>
Create the parent update containing 1 inline step and 1 reference step.</h1>
<h1><a class="anchor" id="autotoc_md54"></a>
---------------------------------------------------—</h1>
<p>Write-Host "    Preparing parent update $parentUpdateIdStr..." $payloadFiles = $parentSteps = @() </p><pre class="fragment">#------------
# ADD STEP(s)

# step #1 - Install 'tree' package
$parentSteps += $topLevelStep1

# step #2 - Install 'motors firmware'
$parentSteps += $topLevelStep2
</pre><h1><a class="anchor" id="autotoc_md55"></a>
---------------------------—</h1>
<h1><a class="anchor" id="autotoc_md56"></a>
Create parent update manifest</h1>
<h1><a class="anchor" id="autotoc_md57"></a>
---------------------------—</h1>
<p>Write-Host "    Generating an import manifest $parentUpdateIdStr..."</p>
<p>$parentManifest = New-AduImportManifest -UpdateId $parentUpdateId <code> -IsDeployable $true</code> -Compatibility $parentCompat <code> -InstallationSteps $parentSteps</code> -ErrorAction Stop</p>
<h1><a class="anchor" id="autotoc_md58"></a>
Create folder for manifest files and payload.</h1>
<p>$outputPath = ".\update-files" Write-Host "    Saving parent manifest file and payload(s) to $outputPath..." New-Item $outputPath -ItemType Directory -ErrorAction SilentlyContinue | Out-Null</p>
<h1><a class="anchor" id="autotoc_md59"></a>
Generate manifest file.</h1>
<p>$parentManifest | Out-File "$outputPath\$parentUpdateIdStr.importmanifest.json" -Encoding utf8</p>
<p>```</p>
<h3><a class="anchor" id="autotoc_md60"></a>
Putting It All Together</h3>
<p>You can find the script for above commands <a href="./tutorial1.ps1">here (tutorial1.ps1)</a></p>
<p><b>Congratulations</b>! At this point, you should be ready to import the update into the Device Update service. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
