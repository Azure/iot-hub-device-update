
pr:
    branches:
        include:
            - feature/wiot-s1
    paths:
        exclude:
            - docs/*
            - README.md
            - LICENSE.md
            - .clang-format
            - .cmake-format.json
            - tools/*
            - docker/*
            - licenses/*

trigger:
    branches:
        include:
            - feature/wiot-s1
    paths:
        exclude:
            - docs/*
            - README.md
            - LICENSE.md
            - .clang-format
            - .cmake-format.json
            - tools/*
            - docker/*
            - licenses/*

pool:
    vmImage: windows-2022

steps:
    - task: PowerShell@2
      displayName: "Build Client, Unit Tests: amd64_debug"
      inputs:
          targetType: "filePath"
          filePath: $(Build.SourcesDirectory)\scripts\build.ps1
          arguments: >
              -Type Debug
              -Clean
              -BuildUnitTests
              -NoPrompt

    - task: PowerShell@2
      displayName: "Run Unit Tests - amd64_debug"
      inputs:
          targetType: inline
          script: $(Build.SourcesDirectory)\scripts\run_uts.ps1 -Pipeline

    - task: PublishTestResults@2
      inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/TEST-*.xml'
          failTaskOnFailedTests: true

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: 'out/Debug/bin/Debug'
        artifact: 'bin-amd64_debug'
        publishLocation: 'pipeline'

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: 'out/Debug/lib/Debug'
        artifact: 'lib-Debug-amd64'
        publishLocation: 'pipeline'

    - task: PowerShell@2
      displayName: "Build Client, Unit Tests: arm64_release"
      inputs:
          targetType: "filePath"
          filePath: $(Build.SourcesDirectory)\scripts\build.ps1
          arguments: >
              -Type Release
              -GeneratorPlatform ARM64
              -Clean
              -BuildUnitTests
              -NoPrompt

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: 'out/ARM64-Release/bin/Release'
        artifact: 'bin-arm64_release'
        publishLocation: 'pipeline'

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: 'out/ARM64-Release/lib/Release'
        artifact: 'lib-arm64_release'
        publishLocation: 'pipeline'

