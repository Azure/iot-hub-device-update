# E2E test pipeline - performs end-to-end tests on the following platforms
#  - Ubuntu 20.04

resources:
    containers:
        - container: ubuntu
          image: ubuntu:20.04
    repositories:
        - repository: 1ESPipelineTemplates
          type: git
          name: 1ESPipelineTemplates/1ESPipelineTemplates
          ref: refs/tags/release

parameters:
    - name: SKIP_TEARDOWN
      displayName: "Leave test infrastructure in-place"
      type: boolean
      default: false

variables:
    SKIP_TEARDOWN: ${{ parameters.SKIP_TEARDOWN }}
    E2E_WORKING_DIR: $(Build.SourcesDirectory)/azurepipelines/e2e_test

    VM_SSH_KEY: ""
    Test_Vm_Ssh_PublicKey: ""
    Test_Vm_Ssh_PrivateKeyFile: "e2e_vm_key"
    Test_Vm_Ssh_PublicKeyFile: "e2e_vm_key.pub"
    Test_VmAdmin: "azureuser"
    Test_ResourceGroupname: "" # Composed of e2e-rg-$(Build.BuildId)
    Test_VmName: ""            # Composed of e2e-vm-$(Build.BuildId)
    Test_InfraDeploymentName: "" #Composed of e2e-deployment-$(Build.BuildId)
    Test_VmHostname: "" # Set after the VM is created
    Test_Location: "westus3"

name: "E2E Automated Test Run"

extends:
  template: v1/1ES.Unofficial.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: aduc_1es_client_pool
      os: linux

    sdl:
      sourceAnalysisPool:
        name: 1es_hosted_pool_windows
        os: windows
      suppression:
        suppressionFile: $(Build.SourcesDirectory)\guardian\SDL\.gdnsuppress
    customBuildTags:
    - ES365AIMigrationTooling

    stages:
        # - stage: PerformNativeBuilds
        #   displayName: Builds all the native architecture builds
        #   jobs:
        #       - job: BuildUbuntu_2004_AMD64
        #         displayName: Building the Device Update Package for Ubuntu 20.04 AMD64
        #         continueOnError: False
        #         pool: aduc_1es_client_pool
        #         steps:
        #             - template: /azurepipelines/build/templates/adu-docker-build-steps.yml@self
        #               parameters:
        #                   targetOs: ubuntu2004
        #                   targetArch: amd64

        - stage: InitializeTestInfra
          displayName: Initializes the Terraform VMs for the Automated Tests
          variables:
              TERRAFORM_RESOURCE_GROUP_NAME: $[ stageDependencies.TerraformSetup.TerraformInstall.outputs['resource_group_name_step.TERRAFORM_RESOURCE_GROUP_NAME'] ]
          pool: aduc_1es_client_pool
          jobs:
              - job: SetupUbuntu2004_AMD64_VM
                displayName: "Setting up VM for Ubuntu 20.04 AMD64 Test VM"
                timeoutInMinutes: 360
                cancelTimeoutInMinutes: 360
                pool: aduc_1es_client_pool
                steps:

                    - bash: |
                        ##vso[task.setvariable variable=Test_ResourceGroupname]e2e-rg-$(Build.BuildId)
                        echo "Setting the Resource Group Name for the E2E Test Infrastructure to $(Test_ResourceGroupname)"
                      displayName: "Set the Resource Group Name for the E2E Test Infrastructure"

                    - bash: |
                        ##vso[task.setvariable variable=Test_VmName]e2e-vm-$(Build.BuildId)
                        echo "Setting the VM Name for the E2E Test Infrastructure to $(Test_VmName)"
                      displayName: "Set the VM Name for the E2E Test"

                    - bash: |
                        ##vso[task.setvariable variable=Test_InfraDeploymentName]e2e-deployment-$(Build.BuildId)
                        echo "Setting the Deployment Name for the E2E Test Infrastructure to $(Test_InfraDeploymentName)"
                      displayName: "Set the Deployment Name for the Infra Deployment"

                    - task: DownloadSecureFile@1
                      displayName: "Download the SSH Key for the VM"
                      name: public_vm_key
                      inputs:
                          secureFile: $(Test_Vm_Ssh_PublicKeyFile)
                          retryCount: 3
                          retryIntervalInSeconds: 5

                    - bash: |
                        ##vso[task.setvariable variable=Test_Vm_Ssh_PublicKey;isSecret=true]$(cat $(public_vm_key.secureFilePath))
                      displayName: "Set the VM SSH Key variable for reading into the Azure VM Template"
                      workingDirectory: $(Agent.TempDirectory)
                    - task: AzureCLI@2
                      displayName: "Create the RG for the E2E Test Infrastructure"
                      inputs:
                          azureSubscription: $(SERVICE_CONNECTION_NAME) # This needs to be changed to MSI?
                          scriptType: bash
                          scriptLocation: inlineScript
                          inlineScript: |
                              echo "Creating the RG for Test Infrastructure"
                              az group create --name $(Test_ResourceGroupname) --location $(Test_Location)
                          failOnStandardError: true
                    - task: AzureCLI@2
                      displayName: "Create the Ubuntu 20.04 VM for the E2E Test"
                      inputs:
                          azureSubscription: $(SERVICE_CONNECTION_NAME) # This needs to be changed to MSI?
                          scriptType: bash
                          scriptLocation: inlineScript
                          inlineScript: |
                              echo "Creating the RG for Test Infrastructure"
                              az group deployment  create --name $(Test_InfraDeploymentName) --resource-group "$(Test_ResourceGroupname)" --template-file ./azurepipelines/e2e_test/templates/az_vm.template.json --parameters adminUsername="$(Test_VmAdmin)" adminPasswordOrKey="$(Test_Vm_Ssh_PublicKey)" authenticationType="sshPublicKey" -VmName="$(Test_VmName)" -VmSize=Standard_DS1_v2 -Location=$(Test_Location)
                          failOnStandardError: true
                    - task: AzureCLI@2
                      displayName: "Get the Public Hostname of the VM"
                      inputs:
                        azureSubscription: $(SERVICE_CONNECTION_NAME)
                        scriptType: bash
                        scriptLocation: inlineScript
                        inlineScript: |
                            echo "Getting the Public IP Address of the VM"
                            ##vso[task.setvariable variable=Test_VmHostname]$(az group deployment show -g $(Test_ResourceGroupname) -n $(Test_InfraDeploymentName) --query properties.outputs.hostname.value)
                        failOnStandardError: true

                    # Install SSH Key to simplify the login process
                    - task: InstallSSHKey@0
                      displayName: "Install the SSH Key for the VM"
                      inputs:
                          sshPublicKey: $(Test_Vm_Ssh_PublicKey)
                          sshKeySecureFile: $(Test_Vm_Ssh_PrivateKeyFile)
                          addEntryToConfig: true
                          configHostname: $(Test_VmHostname)
                          configUser: $(Test_VmAdmin)
                          failOnStdErr: true
                    # InstallSSHKey works by verifying from pre-uploaded keys not existing ones

                    - task: SSH@0
                      displayName: "Attempt a login"
                      inputs:
                          sshEndpoint: $(Test_VmHostname)
                          runOptions: "inline"
                          inline: |
                              echo "Logged in"
                          failOnStdErr: true

#   du_tarball_script: >-
#       tar -xf /tmp/testsetup.tar.gz -C ./ &&
#       chmod u=rwx,g=rwx,o=rx ./testsetup/sas_vm_setup.sh &&
#       ./testsetup/sas_vm_setup.sh --distro ubuntu-20.04 --architecture amd64
#   image_working_directory: $(E2E_WORKING_DIR)
#   device_id_under_test: "ubuntu-20.04-amd64-sas"
