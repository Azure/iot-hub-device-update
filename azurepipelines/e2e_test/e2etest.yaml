# E2E test pipeline - performs end-to-end tests on the following platforms
#  - Ubuntu 20.04

resources:
    containers:
        - container: ubuntu
          image: ubuntu:20.04
    repositories:
        - repository: 1ESPipelineTemplates
          type: git
          name: 1ESPipelineTemplates/1ESPipelineTemplates
          ref: refs/tags/release

parameters:
    - name: SKIP_TEARDOWN
      displayName: "Leave test infrastructure in-place"
      type: boolean
      default: false

variables:
    SKIP_TEARDOWN: ${{ parameters.SKIP_TEARDOWN }}
    E2E_WORKING_DIR: $(Build.SourcesDirectory)/azurepipelines/e2e_test

    Adu_Test_Msi: "adu-client-1es-msi"
    Adu_Arm_Service_Connection: "adu_subscr_servc_connection"
    Test_Vm_Ssh_PublicKey: ""
    Test_Vm_Ssh_PrivateKeyFile: "adu_e2e_test_ssh_key"
    Test_Vm_Ssh_PublicKeyFile: "adu_e2e_test_ssh_key.pub"
    Test_VmAdmin: "azureuser"
    Test_ResourceGroupname: "e2e-rg-$(Build.BuildId)" # Composed of e2e-rg-$(Build.BuildId)
    Test_VmName: "e2e-vm-$(Build.BuildId)"            # Composed of e2e-vm-$(Build.BuildId)
    Test_InfraDeploymentName: "e2e-deployment-$(Build.BuildId)" #Composed of e2e-deployment-$(Build.BuildId)
    Test_VmHostname: "" # Set after the VM is created
    Test_Location: "westus3"

name: "E2E Automated Test Run"
# environment: 'ADU E2E Test Env'
extends:
  template: v1/1ES.Unofficial.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: aduc_1es_client_pool
      os: linux

    sdl:
      sourceAnalysisPool:
        name: 1es_hosted_pool_windows
        os: windows
      suppression:
        suppressionFile: $(Build.SourcesDirectory)\guardian\SDL\.gdnsuppress
    customBuildTags:
    - ES365AIMigrationTooling

    stages:
        # - stage: PerformNativeBuilds
        #   displayName: Builds all the native architecture builds
        #   jobs:
        #       - job: BuildUbuntu_2004_AMD64
        #         displayName: Building the Device Update Package for Ubuntu 20.04 AMD64
        #         continueOnError: False
        #         pool: aduc_1es_client_pool
        #         steps:
        #             - template: /azurepipelines/build/templates/adu-docker-build-steps.yml@self
        #               parameters:
        #                   targetOs: ubuntu2004
        #                   targetArch: amd64

        - stage: InitializeTestInfra
          displayName: Initializes the Terraform VMs for the Automated Tests
          variables:
              TERRAFORM_RESOURCE_GROUP_NAME: $[ stageDependencies.TerraformSetup.TerraformInstall.outputs['resource_group_name_step.TERRAFORM_RESOURCE_GROUP_NAME'] ]
          pool: aduc_1es_client_pool
          jobs:

              - job: SetupUbuntu2004_AMD64_VM
                displayName: "Setting up VM for Ubuntu 20.04 AMD64 Test VM"
                timeoutInMinutes: 360
                cancelTimeoutInMinutes: 360
                pool: aduc_1es_client_pool
                steps:

                    - task: DownloadSecureFile@1
                      displayName: "Download the SSH Key for the VM"
                      name: public_vm_key
                      inputs:
                          secureFile: $(Test_Vm_Ssh_PublicKeyFile)
                          retryCount: 3
                          retryIntervalInSeconds: 5
                    - task: DownloadSecureFile@1
                      displayName: "Download the SSH Key for the VM"
                      name: private_vm_key
                      inputs:
                          secureFile: $(Test_Vm_Ssh_PrivateKeyFile)
                          retryCount: 3
                          retryIntervalInSeconds: 5
                    - bash: |
                         curl -s http://ipinfo.io/json | jq '.ip'
                      displayName: "Get the Public IP Address of the Agent"
                    - bash: |
                        key_contents=$(cat $(public_vm_key.secureFilePath))
                        echo "##vso[task.setvariable variable=Test_Vm_Ssh_PublicKey;isOutput=true;]$key_contents"
                      displayName: "Set the VM SSH Key variable for reading into the Azure VM Template"
                      name: set_ssh_key
                      workingDirectory: $(Agent.TempDirectory)

                    - bash: |
                        echo "The SSH Public Key is $(set_ssh_key.Test_Vm_Ssh_PublicKey)"
                      displayName: "Display the SSH Public Key"
                    - bash: |
                        echo "The Test_ResourceGroupname is $(Test_ResourceGroupname)"
                      displayName: "Display the SSH Public Key"
                    - bash: |
                        echo "The Test_VmName is $(Test_VmName)"
                      displayName: "Display the SSH Public Key"
                    - bash: |
                        echo "The Test_InfraDeploymentName is $(Test_InfraDeploymentName)"
                      displayName: "Display the SSH Public Key"

                    - task: AzureCLI@2
                      displayName: "Create the RG for the E2E Test Infrastructure"
                      inputs:
                          azureSubscription: $(Adu_Arm_Service_Connection)
                          scriptType: bash
                          scriptLocation: inlineScript
                          inlineScript: |
                              echo "Creating the RG for Test Infrastructure"
                              az group create --name $(Test_ResourceGroupname) --location $(Test_Location)
                          failOnStandardError: true

                    - task: AzureCLI@2
                      displayName: "Create the Ubuntu 20.04 VM for the E2E Test"
                      inputs:
                          azureSubscription: $(Adu_Arm_Service_Connection)
                          scriptType: bash
                          scriptLocation: inlineScript
                          inlineScript: |
                              echo "Creating the VM for Test"
                              az deployment group create --name $(Test_InfraDeploymentName) --resource-group "$(Test_ResourceGroupname)" --template-file ./azurepipelines/e2e_test/templates/az_vm.template.json --parameters adminUsername="$(Test_VmAdmin)" adminKey="$(set_ssh_key.Test_Vm_Ssh_PublicKey)" adminPassword="$(VM_ADMIN_PASS)" vmName="$(Test_VmName)" vmSize=Standard_DS1_v2 location=$(Test_Location) msi_resource_id="$(MSI_RESOURCE_ID)" duSetupScriptFileUri="$(VM_SETUP_SCRIPT_URI)" duSetupScriptFileName="$(VM_SETUP_SCRIPT_FILE_NAME)" duSetupScriptParams="--distro ubuntu-20.04 --architecture amd64 -s $(AZURE_STORAGE_ACCOUNT_NAME) -p deviceupdate-agent-1-563.deb"
                          failOnStandardError: true
                    - task: AzureCLI@2
                      displayName: "Get the Public Hostname of the VM"
                      inputs:
                        azureSubscription: $(Adu_Arm_Service_Connection)
                        scriptType: bash
                        scriptLocation: inlineScript
                        inlineScript: |
                            echo "Getting the Public IP Address of the VM"
                            hostname=$(az deployment group show -g $(Test_ResourceGroupname) -n $(Test_InfraDeploymentName) --query properties.outputs.hostname.value)
                            echo "##vso[task.setvariable variable=Test_VmHostname]$hostname"
                        failOnStandardError: true
                    # Trying to copy some stuff over to the file
                    - task: AzureCLI@2
                      displayName: "Attempt to remotely execute a script on the virtual machine"
                      inputs:
                        azureSubscription: $(Adu_Arm_Service_Connection)
                        scriptType: bash
                        scriptLocation: inlineScript
                        inlineScript: |
                            az vm run-command invoke -g $(Test_ResourceGroupname) -n $(Test_VmName) --command-id RunShellScript --scripts "ls /home/"
                        failOnStandardError: true
